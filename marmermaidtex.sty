%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% 
%% (c) Markus Pabst 2022
%%
%% This program can be redistributed and/or modified under the terms
%% of the LaTeX Project Public License Distributed from CTAN archives
%% in directory macros/latex/base/lppl.txt.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% 

%% !Note: You have install mermaid.cli -->  http//:github.com/mermaid-js/mermaid-cli#Install-globally
%% !Note: You have add to pdflatex --shell-escape command


\NeedsTeXFormat{LaTeX2e}[1994/06/01]
\ProvidesPackage{marmermaidtex}
  [2022-01-26 v0.2 LaTeX package for include mermaid graphics in latex]
\RequirePackage{iftex}
\RequirePackage{ifpdf}
\RequirePackage{ifthen}
\RequirePackage{graphicx}

\newboolean{correctTool}   
\setboolean{correctTool}{false} 
\ifXeTeX
	\setboolean{correctTool}{true} 
\fi
\ifpdf
	\setboolean{correctTool}{true} 
\fi

\ifthenelse{\boolean{correctTool}}{}{\errmessage{You aren't using pdflatex, Xetex, Luatex}} 
\newenvironment{marmermaidtex}[2][]{
		\def\@graphicsopts{#1}
		\def\tempFilenameMermaidPdf{#2}
		%%% https://tex.stackexchange.com/questions/130294/filecontents-and-newenvironment-issue
		%%% save code to file
		\csname filecontents*\endcsname[overwrite]{\tempFilenameMermaidPdf.tmp}		
	}
	{
		\csname endfilecontents*\endcsname
		\immediate\write18{mmdc -i \tempFilenameMermaidPdf.tmp -f -o \tempFilenameMermaidPdf}
			
		%%% https://tex.stackexchange.com/questions/79494/keyval-error-with-includegraphics-options-undefined
		\expandafter\includegraphics\expandafter[\@graphicsopts]{\tempFilenameMermaidPdf}
	}

\endinput
%%
%% End of file `marmermaidtex.sty'.